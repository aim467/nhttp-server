<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - nhttp-server</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Viewer.js CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/viewerjs@1.11.6/dist/viewer.min.css">
    <!-- XGPlayer CSS -->
    <link rel="stylesheet" href="https://unpkg.com/xgplayer@3.0.20/dist/index.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body class="windows-explorer">
    <!-- Windows-style Header -->
    <div class="explorer-header">
        <div class="container-fluid">
            <!-- Address Bar -->
            <div class="address-bar d-flex align-items-center mb-2">
                <div class="breadcrumb-nav flex-grow-1">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item">
                                <i class="bi bi-hdd me-1"></i>
                                <span><%- breadcrumb %></span>
                            </li>
                        </ol>
                    </nav>
                </div>
                <div class="search-box ms-3">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" class="form-control" id="searchInput" placeholder="搜索">
                    </div>
                </div>
            </div>
            
            <!-- Toolbar -->
            <div class="toolbar d-flex align-items-center justify-content-between">
                <div class="toolbar-left d-flex align-items-center gap-2">
                    <% if (parentPath) { %>
                    <button class="btn btn-sm btn-outline-secondary" onclick="location.href='<%= parentPath %>'" title="向上">
                        <i class="bi bi-arrow-up"></i>
                    </button>
                    <% } %>
                    <button class="btn btn-sm btn-outline-secondary" onclick="location.reload()" title="刷新">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                
                <div class="toolbar-right d-flex align-items-center gap-2">
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-secondary" id="viewToggle" title="切换视图">
                            <i class="bi bi-list"></i>
                        </button>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="bi bi-sort-alpha-down"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" data-sort="name">按名称排序</a></li>
                                <li><a class="dropdown-item" href="#" data-sort="date">按修改日期排序</a></li>
                                <li><a class="dropdown-item" href="#" data-sort="size">按大小排序</a></li>
                            </ul>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary" id="themeToggle" title="切换主题">
                        <i class="bi bi-moon"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- File List Container -->
    <div class="file-container">
        <div class="container-fluid">
            <!-- List View Header -->
            <div class="list-header d-none">
                <div class="row">
                    <div class="col-4">
                        <small class="text-muted fw-bold">名称</small>
                    </div>
                    <div class="col-2">
                        <small class="text-muted fw-bold">修改日期</small>
                    </div>
                    <div class="col-2">
                        <small class="text-muted fw-bold">类型</small>
                    </div>
                    <div class="col-2">
                        <small class="text-muted fw-bold">大小</small>
                    </div>
                    <div class="col-2 text-end">
                        <small class="text-muted fw-bold">操作</small>
                    </div>
                </div>
                <hr class="my-1">
            </div>

            <!-- File List -->
            <div id="fileList" class="file-list">
                <% fileItems.forEach(function(file) { %>
                <div class="file-item <%= file.isDirectory ? 'directory' : 'file' %>" 
                     data-name="<%= file.name %>"
                     data-size="<%= file.formattedSize %>"
                     data-date="<%= file.formattedDate %>"
                     data-href="<%= file.href %>"
                     data-is-directory="<%= file.isDirectory %>"
                     data-media-type="<%= file.mediaType || '' %>"
                     <% if (file.mediaType === 'image') { %>
                     data-viewer-image="<%= file.href %>"
                     <% } else if (file.mediaType) { %>
                     onclick="showMediaPreview('<%= file.href %>', '<%= file.mediaType %>', '<%= file.name %>')"
                     <% } else { %>
                     onclick="location.href='<%= file.href %>'"
                     <% } %>>
                    
                    <!-- Grid View Layout -->
                    <div class="grid-layout">
                        <div class="file-icon-large">
                            <% if (file.isDirectory) { %>
                                <i class="bi bi-folder-fill text-warning"></i>
                            <% } else if (file.mediaType === 'image') { %>
                                <i class="bi bi-file-earmark-image text-success"></i>
                            <% } else if (file.mediaType === 'video') { %>
                                <i class="bi bi-file-earmark-play text-danger"></i>
                            <% } else if (file.mediaType === 'audio') { %>
                                <i class="bi bi-file-earmark-music text-info"></i>
                            <% } else { %>
                                <i class="bi bi-file-earmark text-secondary"></i>
                            <% } %>
                        </div>
                        <div class="file-name-grid"><%= file.name %></div>
                        <!-- 操作按钮 (网格视图) -->
                        <div class="file-actions-grid">
                            <% if (!file.isDirectory) { %>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="event.stopPropagation(); previewFile('<%= file.href %>', '<%= file.mediaType %>', '<%= file.name %>')" title="预览">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); downloadFile('<%= file.href %>', '<%= file.name %>')" title="下载">
                                <i class="bi bi-download"></i>
                            </button>
                            <% } %>
                        </div>
                    </div>

                    <!-- List View Layout -->
                    <div class="list-layout d-none">
                        <div class="row align-items-center">
                            <div class="col-4 d-flex align-items-center">
                                <div class="file-icon-small me-2">
                                    <% if (file.isDirectory) { %>
                                        <i class="bi bi-folder-fill text-warning"></i>
                                    <% } else if (file.mediaType === 'image') { %>
                                        <i class="bi bi-file-earmark-image text-success"></i>
                                    <% } else if (file.mediaType === 'video') { %>
                                        <i class="bi bi-file-earmark-play text-danger"></i>
                                    <% } else if (file.mediaType === 'audio') { %>
                                        <i class="bi bi-file-earmark-music text-info"></i>
                                    <% } else { %>
                                        <i class="bi bi-file-earmark text-secondary"></i>
                                    <% } %>
                                </div>
                                <span class="file-name-list"><%= file.name %></span>
                            </div>
                            <div class="col-2">
                                <small class="text-muted"><%= file.formattedDate %></small>
                            </div>
                            <div class="col-2">
                                <small class="text-muted">
                                    <% if (file.isDirectory) { %>
                                        文件夹
                                    <% } else { %>
                                        文件
                                    <% } %>
                                </small>
                            </div>
                            <div class="col-2">
                                <small class="text-muted"><%= file.formattedSize %></small>
                            </div>
                            <div class="col-2 text-end">
                                <!-- 操作按钮 (列表视图) -->
                                <% if (!file.isDirectory) { %>
                                <div class="file-actions-list">
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="event.stopPropagation(); previewFile('<%= file.href %>', '<%= file.mediaType %>', '<%= file.name %>')" title="预览">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); downloadFile('<%= file.href %>', '<%= file.name %>')" title="下载">
                                        <i class="bi bi-download"></i>
                                    </button>
                                </div>
                                <% } %>
                            </div>
                        </div>
                    </div>

                    <% if (file.mediaType === 'image') { %>
                    <img src="<%= file.href %>" alt="<%= file.name %>" style="display: none;" class="viewer-image">
                    <% } %>
                </div>
                <% }); %>
            </div>
        </div>
    </div>

    <!-- Bootstrap 媒体预览模态框 -->
    <div class="modal fade" id="mediaModal" tabindex="-1" aria-labelledby="mediaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content bg-dark">
                <div class="modal-header border-0">
                    <h5 class="modal-title text-white" id="mediaModalLabel">媒体预览</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center p-0" id="modalBody">
                    <!-- 媒体内容将在这里显示 -->
                    <div id="xgPlayerContainer" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 文件预览浮窗 -->
    <div id="filePreviewPopup" class="file-preview-popup" style="display: none;">
        <div class="file-preview-header">
            <div class="file-preview-title">
                <i class="bi bi-file-earmark-text me-2"></i>
                <span id="previewFileName">文件名</span>
            </div>
            <div class="file-preview-actions">
                <button class="btn btn-sm btn-outline-light me-1" onclick="openInNewTab()" title="在新标签页打开">
                    <i class="bi bi-box-arrow-up-right"></i>
                </button>
                <button class="btn btn-sm btn-outline-light" onclick="closeFilePreview()" title="关闭">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        </div>
        <div class="file-preview-info">
            <span class="me-3" id="previewFileSize">
                <i class="bi bi-hdd me-1"></i>大小
            </span>
            <span class="me-3" id="previewFileDate">
                <i class="bi bi-calendar me-1"></i>修改日期
            </span>
            <span class="me-3" id="previewFileEncoding">
                <i class="bi bi-keyboard me-1"></i>编码
            </span>
            <span id="previewFileType">
                <i class="bi bi-file-earmark me-1"></i>类型
            </span>
        </div>
        <div class="file-preview-toolbar">
            <select id="encodingSelect" class="form-select form-select-sm" onchange="changeEncoding(this.value)">
                <option value="auto">自动检测</option>
                <option value="UTF-8">UTF-8</option>
                <option value="GBK">GBK/GB2312</option>
                <option value="GB18030">GB18030</option>
                <option value="Big5">Big5</option>
                <option value="Shift_JIS">Shift_JIS</option>
                <option value="EUC-KR">EUC-KR</option>
                <option value="ISO-8859-1">ISO-8859-1</option>
                <option value="windows-1252">Windows-1252</option>
            </select>
            <div class="btn-group btn-group-sm ms-2">
                <button class="btn btn-outline-light" onclick="wrapText(true)" title="自动换行">
                    <i class="bi bi-text-wrap"></i>
                </button>
                <button class="btn btn-outline-light" onclick="wrapText(false)" title="不换行">
                    <i class="bi bi-unindent"></i>
                </button>
            </div>
            <div class="ms-auto">
                <span class="badge bg-secondary" id="previewLineCount">0 行</span>
            </div>
        </div>
        <div class="file-preview-content" id="previewContent">
            <div class="text-center text-muted p-4">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                <span>加载中...</span>
            </div>
        </div>
        <div class="file-preview-status" id="previewStatus"></div>
    </div>
    
    <!-- 浮窗遮罩层 -->
    <div id="previewOverlay" class="preview-overlay" style="display: none;" onclick="closeFilePreview()"></div>

    <!-- 快捷键帮助模态框 -->
    <div class="modal fade" id="shortcutsModal" tabindex="-1" aria-labelledby="shortcutsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="shortcutsModalLabel">
                        <i class="bi bi-keyboard me-2"></i>键盘快捷键
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="d-flex align-items-center">
                                <kbd class="me-2">/</kbd>
                                <span>聚焦搜索</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex align-items-center">
                                <kbd class="me-2">V</kbd>
                                <span>切换视图</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex align-items-center">
                                <kbd class="me-2">T</kbd>
                                <span>切换主题</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex align-items-center">
                                <kbd class="me-2">R</kbd>
                                <span>刷新页面</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex align-items-center">
                                <kbd class="me-2">ESC</kbd>
                                <span>清除搜索</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex align-items-center">
                                <kbd class="me-2">?</kbd>
                                <span>显示帮助</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 右键菜单 -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" data-action="preview">
            <i class="bi bi-eye me-2"></i>预览
        </div>
        <div class="context-menu-item" data-action="download">
            <i class="bi bi-download me-2"></i>下载
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" data-action="copy-link">
            <i class="bi bi-link-45deg me-2"></i>复制链接
        </div>
        <div class="context-menu-item" data-action="open-new-tab">
            <i class="bi bi-box-arrow-up-right me-2"></i>在新标签页中打开
        </div>
    </div>

    <!-- 快捷键提示 Toast -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="shortcutsToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="bi bi-keyboard text-primary me-2"></i>
                <strong class="me-auto">快捷键提示</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                按 <kbd>?</kbd> 查看所有快捷键
            </div>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Viewer.js JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/viewerjs@1.11.6/dist/viewer.min.js"></script>
    <!-- XGPlayer JavaScript -->
    <script src="https://unpkg.com/xgplayer@3.0.20/dist/index.min.js"></script>
    <!-- Custom JavaScript -->
    <script src="/static/app.js"></script>
</body>
</html>
