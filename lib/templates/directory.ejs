<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - nhttp-server</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Viewer.js CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/viewerjs@1.11.6/dist/viewer.min.css">
    <!-- XGPlayer CSS -->
    <link rel="stylesheet" href="https://unpkg.com/xgplayer@3.0.20/dist/index.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body class="windows-explorer">
    <!-- Windows-style Header -->
    <div class="explorer-header">
        <div class="container-fluid">
            <!-- Address Bar -->
            <div class="address-bar d-flex align-items-center mb-2">
                <div class="breadcrumb-nav flex-grow-1">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item">
                                <i class="bi bi-hdd me-1"></i>
                                <span><%- breadcrumb %></span>
                            </li>
                        </ol>
                    </nav>
                </div>
                <div class="search-box ms-3">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" class="form-control" id="searchInput" placeholder="搜索">
                    </div>
                </div>
            </div>
            
            <!-- Toolbar -->
            <div class="toolbar d-flex align-items-center justify-content-between">
                <div class="toolbar-left d-flex align-items-center gap-2">
                    <% if (parentPath) { %>
                    <button class="btn btn-sm btn-outline-secondary" onclick="location.href='<%= parentPath %>'" title="向上">
                        <i class="bi bi-arrow-up"></i>
                    </button>
                    <% } %>
                    <button class="btn btn-sm btn-outline-secondary" onclick="location.reload()" title="刷新">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                
                <div class="toolbar-right d-flex align-items-center gap-2">
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-secondary" id="viewToggle" title="切换视图">
                            <i class="bi bi-list"></i>
                        </button>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="bi bi-sort-alpha-down"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" data-sort="name">按名称排序</a></li>
                                <li><a class="dropdown-item" href="#" data-sort="date">按修改日期排序</a></li>
                                <li><a class="dropdown-item" href="#" data-sort="size">按大小排序</a></li>
                            </ul>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary" id="themeToggle" title="切换主题">
                        <i class="bi bi-moon"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- File List Container -->
    <div class="file-container">
        <div class="container-fluid">
            <!-- List View Header -->
            <div class="list-header d-none">
                <div class="row">
                    <div class="col-4">
                        <small class="text-muted fw-bold">名称</small>
                    </div>
                    <div class="col-2">
                        <small class="text-muted fw-bold">修改日期</small>
                    </div>
                    <div class="col-2">
                        <small class="text-muted fw-bold">类型</small>
                    </div>
                    <div class="col-2">
                        <small class="text-muted fw-bold">大小</small>
                    </div>
                    <div class="col-2 text-end">
                        <small class="text-muted fw-bold">操作</small>
                    </div>
                </div>
                <hr class="my-1">
            </div>

            <!-- File List -->
            <div id="fileList" class="file-list">
                <% fileItems.forEach(function(file) { %>
                <div class="file-item <%= file.isDirectory ? 'directory' : 'file' %>" 
                     data-name="<%= file.name %>"
                     data-size="<%= file.formattedSize %>"
                     data-date="<%= file.formattedDate %>"
                     data-href="<%= file.href %>"
                     data-is-directory="<%= file.isDirectory %>"
                     data-media-type="<%= file.mediaType || '' %>"
                     <% if (file.mediaType === 'image') { %>
                     data-viewer-image="<%= file.href %>"
                     <% } else if (file.mediaType) { %>
                     onclick="showMediaPreview('<%= file.href %>', '<%= file.mediaType %>', '<%= file.name %>')"
                     <% } else { %>
                     onclick="location.href='<%= file.href %>'"
                     <% } %>>
                    
                    <!-- Grid View Layout -->
                    <div class="grid-layout">
                        <div class="file-icon-large">
                            <% if (file.isDirectory) { %>
                                <i class="bi bi-folder-fill text-warning"></i>
                            <% } else if (file.mediaType === 'image') { %>
                                <i class="bi bi-file-earmark-image text-success"></i>
                            <% } else if (file.mediaType === 'video') { %>
                                <i class="bi bi-file-earmark-play text-danger"></i>
                            <% } else if (file.mediaType === 'audio') { %>
                                <i class="bi bi-file-earmark-music text-info"></i>
                            <% } else { %>
                                <i class="bi bi-file-earmark text-secondary"></i>
                            <% } %>
                        </div>
                        <div class="file-name-grid"><%= file.name %></div>
                        <!-- 操作按钮 (网格视图) -->
                        <div class="file-actions-grid">
                            <% if (!file.isDirectory) { %>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="event.stopPropagation(); previewFile('<%= file.href %>', '<%= file.mediaType %>', '<%= file.name %>')" title="预览">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); downloadFile('<%= file.href %>', '<%= file.name %>')" title="下载">
                                <i class="bi bi-download"></i>
                            </button>
                            <% } %>
                        </div>
                    </div>

                    <!-- List View Layout -->
                    <div class="list-layout d-none">
                        <div class="row align-items-center">
                            <div class="col-4 d-flex align-items-center">
                                <div class="file-icon-small me-2">
                                    <% if (file.isDirectory) { %>
                                        <i class="bi bi-folder-fill text-warning"></i>
                                    <% } else if (file.mediaType === 'image') { %>
                                        <i class="bi bi-file-earmark-image text-success"></i>
                                    <% } else if (file.mediaType === 'video') { %>
                                        <i class="bi bi-file-earmark-play text-danger"></i>
                                    <% } else if (file.mediaType === 'audio') { %>
                                        <i class="bi bi-file-earmark-music text-info"></i>
                                    <% } else { %>
                                        <i class="bi bi-file-earmark text-secondary"></i>
                                    <% } %>
                                </div>
                                <span class="file-name-list"><%= file.name %></span>
                            </div>
                            <div class="col-2">
                                <small class="text-muted"><%= file.formattedDate %></small>
                            </div>
                            <div class="col-2">
                                <small class="text-muted">
                                    <% if (file.isDirectory) { %>
                                        文件夹
                                    <% } else { %>
                                        文件
                                    <% } %>
                                </small>
                            </div>
                            <div class="col-2">
                                <small class="text-muted"><%= file.formattedSize %></small>
                            </div>
                            <div class="col-2 text-end">
                                <!-- 操作按钮 (列表视图) -->
                                <% if (!file.isDirectory) { %>
                                <div class="file-actions-list">
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="event.stopPropagation(); previewFile('<%= file.href %>', '<%= file.mediaType %>', '<%= file.name %>')" title="预览">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); downloadFile('<%= file.href %>', '<%= file.name %>')" title="下载">
                                        <i class="bi bi-download"></i>
                                    </button>
                                </div>
                                <% } %>
                            </div>
                        </div>
                    </div>

                    <% if (file.mediaType === 'image') { %>
                    <img src="<%= file.href %>" alt="<%= file.name %>" style="display: none;" class="viewer-image">
                    <% } %>
                </div>
                <% }); %>
            </div>
        </div>
    </div>

    <!-- Bootstrap 媒体预览模态框 -->
    <div class="modal fade" id="mediaModal" tabindex="-1" aria-labelledby="mediaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content bg-dark">
                <div class="modal-header border-0">
                    <h5 class="modal-title text-white" id="mediaModalLabel">媒体预览</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center p-0" id="modalBody">
                    <!-- 媒体内容将在这里显示 -->
                    <div id="xgPlayerContainer" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 快捷键帮助模态框 -->
    <div class="modal fade" id="shortcutsModal" tabindex="-1" aria-labelledby="shortcutsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="shortcutsModalLabel">
                        <i class="bi bi-keyboard me-2"></i>键盘快捷键
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="d-flex align-items-center">
                                <kbd class="me-2">/</kbd>
                                <span>聚焦搜索</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex align-items-center">
                                <kbd class="me-2">V</kbd>
                                <span>切换视图</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex align-items-center">
                                <kbd class="me-2">T</kbd>
                                <span>切换主题</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex align-items-center">
                                <kbd class="me-2">R</kbd>
                                <span>刷新页面</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex align-items-center">
                                <kbd class="me-2">ESC</kbd>
                                <span>清除搜索</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex align-items-center">
                                <kbd class="me-2">?</kbd>
                                <span>显示帮助</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 右键菜单 -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" data-action="preview">
            <i class="bi bi-eye me-2"></i>预览
        </div>
        <div class="context-menu-item" data-action="download">
            <i class="bi bi-download me-2"></i>下载
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" data-action="copy-link">
            <i class="bi bi-link-45deg me-2"></i>复制链接
        </div>
        <div class="context-menu-item" data-action="open-new-tab">
            <i class="bi bi-box-arrow-up-right me-2"></i>在新标签页中打开
        </div>
    </div>

    <!-- 快捷键提示 Toast -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="shortcutsToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="bi bi-keyboard text-primary me-2"></i>
                <strong class="me-auto">快捷键提示</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                按 <kbd>?</kbd> 查看所有快捷键
            </div>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Viewer.js JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/viewerjs@1.11.6/dist/viewer.min.js"></script>
    <!-- XGPlayer JavaScript -->
    <script src="https://unpkg.com/xgplayer@3.0.20/dist/index.min.js"></script>
    <!-- Custom JavaScript -->
    <script src="/static/app.js"></script>
    
    <script>
        // 全局变量
        let currentXGPlayer = null;

        // 初始化 Bootstrap 工具提示
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化所有工具提示
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // 初始化 Viewer.js 图片预览
            const fileList = document.getElementById('fileList');
            if (fileList) {
                const viewer = new Viewer(fileList, {
                    filter: function(image) {
                        return image.classList.contains('viewer-image');
                    },
                    url: function(image) {
                        return image.src;
                    },
                    title: function(image) {
                        return image.alt;
                    },
                    toolbar: {
                        zoomIn: 1,
                        zoomOut: 1,
                        oneToOne: 1,
                        reset: 1,
                        prev: 1,
                        play: {
                            show: 1,
                            size: 'large',
                        },
                        next: 1,
                        rotateLeft: 1,
                        rotateRight: 1,
                        flipHorizontal: 1,
                        flipVertical: 1,
                    },
                    navbar: true,
                    tooltip: true,
                    movable: true,
                    zoomable: true,
                    rotatable: true,
                    scalable: true,
                    transition: true,
                    fullscreen: true,
                    keyboard: true,
                });

                // 为图片文件项添加点击事件
                const imageItems = fileList.querySelectorAll('[data-viewer-image]');
                imageItems.forEach(function(item) {
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        const img = item.querySelector('.viewer-image');
                        if (img) {
                            const index = Array.from(fileList.querySelectorAll('.viewer-image')).indexOf(img);
                            viewer.view(index);
                        }
                    });
                });
            }

            // 显示快捷键提示 Toast
            setTimeout(() => {
                const toast = new bootstrap.Toast(document.getElementById('shortcutsToast'));
                toast.show();
            }, 2000);
        });

        // XGPlayer 视频播放函数
        function showVideoWithXGPlayer(videoUrl, fileName) {
            const modalBody = document.getElementById('modalBody');
            const xgPlayerContainer = document.getElementById('xgPlayerContainer');
            const mediaModal = document.getElementById('mediaModal');
            const modalLabel = document.getElementById('mediaModalLabel');
            
            // 清理之前的内容
            modalBody.innerHTML = '';
            modalBody.appendChild(xgPlayerContainer);
            xgPlayerContainer.style.display = 'block';
            xgPlayerContainer.innerHTML = '';
            
            // 设置模态框标题
            modalLabel.textContent = fileName;
            
            // 销毁之前的播放器实例
            if (currentXGPlayer) {
                currentXGPlayer.destroy();
                currentXGPlayer = null;
            }
            
            // 创建新的 XGPlayer 实例
            currentXGPlayer = new Player({
                id: 'xgPlayerContainer',
                url: videoUrl,
                width: '100%',
                height: '500px',
                autoplay: false,
                volume: 0.8,
                poster: '',
                playsinline: true,
                fluid: true,
                videoInit: true,
                controls: {
                    mode: 'normal'
                },
                plugins: [
                    // 可以在这里添加更多插件
                ]
            });
            
            // 显示模态框
            const modal = new bootstrap.Modal(mediaModal);
            modal.show();
            
            // 监听模态框关闭事件，销毁播放器
            mediaModal.addEventListener('hidden.bs.modal', function() {
                if (currentXGPlayer) {
                    currentXGPlayer.destroy();
                    currentXGPlayer = null;
                }
                xgPlayerContainer.style.display = 'none';
                xgPlayerContainer.innerHTML = '';
            }, { once: true });
        }

        // 媒体预览函数（兼容原有功能）
        function showMediaPreview(url, mediaType, fileName) {
            if (mediaType === 'video') {
                showVideoWithXGPlayer(url, fileName);
            } else if (mediaType === 'audio') {
                // 保持原有的音频播放逻辑
                showAudioPreview(url, fileName);
            } else {
                // 其他媒体类型的处理
                console.log('不支持的媒体类型:', mediaType);
            }
        }

        // 音频预览函数
        function showAudioPreview(audioUrl, fileName) {
            const modalBody = document.getElementById('modalBody');
            const mediaModal = document.getElementById('mediaModal');
            const modalLabel = document.getElementById('mediaModalLabel');
            
            modalLabel.textContent = fileName;
            modalBody.innerHTML = `
                <div class="p-4">
                    <audio controls class="w-100" style="max-width: 500px;">
                        <source src="${audioUrl}" type="audio/mpeg">
                        <source src="${audioUrl}" type="audio/wav">
                        <source src="${audioUrl}" type="audio/ogg">
                        您的浏览器不支持音频播放。
                    </audio>
                </div>
            `;
            
            const modal = new bootstrap.Modal(mediaModal);
            modal.show();
        }

        // 预览文件函数（供按钮调用）
        function previewFile(url, mediaType, fileName) {
            showMediaPreview(url, mediaType, fileName);
        }

        // 下载文件函数
        function downloadFile(url, fileName) {
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>