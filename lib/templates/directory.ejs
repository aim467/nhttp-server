<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - nhttp-server</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Viewer.js CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/viewerjs@1.11.6/dist/viewer.min.css">
    <!-- XGPlayer CSS -->
    <link rel="stylesheet" href="https://unpkg.com/xgplayer@3.0.20/dist/index.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/components.css">
    <%
    function getFileIcon(file) {
        if (file.isDirectory) return { icon: 'bi-folder-fill', color: 'text-warning' };
        
        const ext = file.name.split('.').pop().toLowerCase();
        const map = {
            'pdf': { icon: 'bi-file-earmark-pdf-fill', color: 'text-danger' },
            'doc': { icon: 'bi-file-earmark-word-fill', color: 'text-primary' },
            'docx': { icon: 'bi-file-earmark-word-fill', color: 'text-primary' },
            'xls': { icon: 'bi-file-earmark-excel-fill', color: 'text-success' },
            'xlsx': { icon: 'bi-file-earmark-excel-fill', color: 'text-success' },
            'ppt': { icon: 'bi-file-earmark-ppt-fill', color: 'text-warning' },
            'pptx': { icon: 'bi-file-earmark-ppt-fill', color: 'text-warning' },
            'txt': { icon: 'bi-file-earmark-text-fill', color: 'text-secondary' },
            'md': { icon: 'bi-markdown-fill', color: 'text-info' },
            'json': { icon: 'bi-filetype-json', color: 'text-warning' },
            'js': { icon: 'bi-filetype-js', color: 'text-warning' },
            'css': { icon: 'bi-filetype-css', color: 'text-primary' },
            'html': { icon: 'bi-filetype-html', color: 'text-danger' },
            'zip': { icon: 'bi-file-earmark-zip-fill', color: 'text-warning' },
            'rar': { icon: 'bi-file-earmark-zip-fill', color: 'text-warning' },
            '7z': { icon: 'bi-file-earmark-zip-fill', color: 'text-warning' },
            'tar': { icon: 'bi-file-earmark-zip-fill', color: 'text-warning' },
            'gz': { icon: 'bi-file-earmark-zip-fill', color: 'text-warning' },
            'mp3': { icon: 'bi-file-earmark-music-fill', color: 'text-info' },
            'wav': { icon: 'bi-file-earmark-music-fill', color: 'text-info' },
            'mp4': { icon: 'bi-file-earmark-play-fill', color: 'text-danger' },
            'mkv': { icon: 'bi-file-earmark-play-fill', color: 'text-danger' },
            'jpg': { icon: 'bi-file-earmark-image-fill', color: 'text-success' },
            'jpeg': { icon: 'bi-file-earmark-image-fill', color: 'text-success' },
            'png': { icon: 'bi-file-earmark-image-fill', color: 'text-success' },
            'gif': { icon: 'bi-file-earmark-image-fill', color: 'text-success' },
            'svg': { icon: 'bi-filetype-svg', color: 'text-warning' }
        };

        if (map[ext]) return map[ext];
        
        if (file.mediaType === 'image') return { icon: 'bi-file-earmark-image-fill', color: 'text-success' };
        if (file.mediaType === 'video') return { icon: 'bi-file-earmark-play-fill', color: 'text-danger' };
        if (file.mediaType === 'audio') return { icon: 'bi-file-earmark-music-fill', color: 'text-info' };
        
        return { icon: 'bi-file-earmark-fill', color: 'text-secondary' };
    }
    %>
</head>
<body class="windows-explorer">
    <!-- Windows-style Header -->
    <div class="explorer-header">
        <div class="container-fluid">
            <!-- Address Bar -->
            <div class="address-bar d-flex align-items-center mb-2">
                <div class="breadcrumb-nav flex-grow-1">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item">
                                <i class="bi bi-hdd me-1"></i>
                                <span><%- breadcrumb %></span>
                            </li>
                        </ol>
                    </nav>
                </div>
                <div class="search-box ms-3">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" class="form-control" id="searchInput" placeholder="搜索">
                    </div>
                </div>
            </div>
            
            <!-- Toolbar -->
            <div class="toolbar d-flex align-items-center justify-content-between">
                <div class="toolbar-left d-flex align-items-center gap-2">
                    <% if (parentPath) { %>
                    <button class="btn btn-sm btn-outline-secondary" onclick="location.href='<%= parentPath %>'" title="向上">
                        <i class="bi bi-arrow-up"></i>
                    </button>
                    <% } %>
                    <button class="btn btn-sm btn-outline-secondary" onclick="location.reload()" title="刷新">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                
                <div class="toolbar-right d-flex align-items-center gap-2">
                    <% if (authEnabled) { %>
                    <button class="btn btn-sm btn-outline-success" id="uploadBtn" title="上传文件">
                        <i class="bi bi-cloud-upload"></i>
                        <span class="d-none d-md-inline ms-1">上传</span>
                    </button>
                    <% } %>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-secondary" id="viewToggle" title="切换视图">
                            <i class="bi bi-list"></i>
                        </button>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="bi bi-sort-alpha-down"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" data-sort="name">按名称排序</a></li>
                                <li><a class="dropdown-item" href="#" data-sort="date">按修改日期排序</a></li>
                                <li><a class="dropdown-item" href="#" data-sort="size">按大小排序</a></li>
                            </ul>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary" id="qrShareCurrent" title="分享当前目录二维码">
                        <i class="bi bi-qr-code"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" id="themeToggle" title="切换主题">
                        <i class="bi bi-moon"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- File List Container -->
    <div class="file-container">
        <div class="container-fluid">
            <!-- List View Header -->
            <div class="list-header d-none">
                <div class="row">
                    <div class="col-4">
                        <small class="text-secondary fw-bold">名称</small>
                    </div>
                    <div class="col-2">
                        <small class="text-secondary fw-bold">修改日期</small>
                    </div>
                    <div class="col-2">
                        <small class="text-secondary fw-bold">类型</small>
                    </div>
                    <div class="col-2">
                        <small class="text-secondary fw-bold">大小</small>
                    </div>
                    <div class="col-2 text-end">
                        <small class="text-secondary fw-bold">操作</small>
                    </div>
                </div>
                <hr class="my-1">
            </div>

            <!-- File List -->
            <div id="fileList" class="file-list">
                <% fileItems.forEach(function(file) { 
                    const iconData = getFileIcon(file);
                %>
                <div class="file-item <%= file.isDirectory ? 'directory' : 'file' %>" 
                     data-name="<%= file.name %>"
                     data-size="<%= file.formattedSize %>"
                     data-date="<%= file.formattedDate %>"
                     data-href="<%= file.href %>"
                     data-is-directory="<%= file.isDirectory %>"
                     data-media-type="<%= file.mediaType || '' %>"
                     data-bs-toggle="tooltip"
                     data-bs-html="true"
                     title="<div class='text-start'>名称: <%= file.name %><br>大小: <%= file.formattedSize %><br>修改: <%= file.formattedDate %></div>"
                     <% if (file.mediaType === 'image') { %>
                     data-viewer-image="<%= file.href %>"
                     <% } else if (file.mediaType) { %>
                     onclick="showMediaPreview('<%= file.href %>', '<%= file.mediaType %>', '<%= file.name %>')"
                     <% } else { %>
                     onclick="location.href='<%= file.href %>'"
                     <% } %>>
                    
                    <!-- Grid View Layout -->
                    <div class="grid-layout">
                        <div class="file-icon-large">
                            <i class="bi <%= iconData.icon %> <%= iconData.color %>"></i>
                        </div>
                        <div class="file-name-grid"><%= file.name %></div>
                        <!-- 操作按钮 (网格视图) -->
                        <div class="file-actions-grid">
                            <% if (!file.isDirectory) { %>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="event.stopPropagation(); previewFile('<%= file.href %>', '<%= file.mediaType %>', '<%= file.name %>')" title="预览" data-bs-toggle="tooltip">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); downloadFile('<%= file.href %>', '<%= file.name %>')" title="下载" data-bs-toggle="tooltip">
                                <i class="bi bi-download"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); shareFileQr('<%= file.href %>', '<%= file.name %>')" title="二维码分享" data-bs-toggle="tooltip">
                                <i class="bi bi-qr-code"></i>
                            </button>
                            <% } %>
                        </div>
                    </div>

                    <!-- List View Layout -->
                    <div class="list-layout d-none">
                        <div class="row align-items-center">
                            <div class="col-4 d-flex align-items-center">
                                <div class="file-icon-small me-2">
                                    <i class="bi <%= iconData.icon %> <%= iconData.color %>"></i>
                                </div>
                                <span class="file-name-list"><%= file.name %></span>
                            </div>
                            <div class="col-2">
                                <small class="text-secondary"><%= file.formattedDate %></small>
                            </div>
                            <div class="col-2">
                                <small class="text-secondary">
                                    <% if (file.isDirectory) { %>
                                        文件夹
                                    <% } else { %>
                                        <%= file.name.split('.').pop().toUpperCase() %> 文件
                                    <% } %>
                                </small>
                            </div>
                            <div class="col-2">
                                <small class="text-secondary"><%= file.formattedSize %></small>
                            </div>
                            <div class="col-2 text-end">
                                <!-- 操作按钮 (列表视图) -->
                                <% if (!file.isDirectory) { %>
                                <div class="file-actions-list">
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="event.stopPropagation(); previewFile('<%= file.href %>', '<%= file.mediaType %>', '<%= file.name %>')" title="预览" data-bs-toggle="tooltip">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); downloadFile('<%= file.href %>', '<%= file.name %>')" title="下载" data-bs-toggle="tooltip">
                                        <i class="bi bi-download"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); shareFileQr('<%= file.href %>', '<%= file.name %>')" title="二维码分享" data-bs-toggle="tooltip">
                                        <i class="bi bi-qr-code"></i>
                                    </button>
                                </div>
                                <% } %>
                            </div>
                        </div>
                    </div>

                    <% if (file.mediaType === 'image') { %>
                    <img src="<%= file.href %>" alt="<%= file.name %>" style="display: none;" class="viewer-image">
                    <% } %>
                </div>
                <% }); %>
            </div>
        </div>
    </div>

    <!-- Bootstrap 媒体预览模态框 -->
    <div class="modal fade" id="mediaModal" tabindex="-1" aria-labelledby="mediaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content bg-dark">
                <div class="modal-header border-0">
                    <h5 class="modal-title text-white" id="mediaModalLabel">媒体预览</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center p-0" id="modalBody">
                    <!-- 媒体内容将在这里显示 -->
                    <div id="xgPlayerContainer" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 文件预览浮窗 -->
    <div id="filePreviewPopup" class="file-preview-popup" style="display: none;">
        <div class="file-preview-header">
            <div class="file-preview-title">
                <i class="bi bi-file-earmark-text me-2"></i>
                <span id="previewFileName">文件名</span>
            </div>
            <div class="file-preview-actions">
                <button class="btn btn-sm btn-outline-light me-1" onclick="openInNewTab()" title="在新标签页打开">
                    <i class="bi bi-box-arrow-up-right"></i>
                </button>
                <button class="btn btn-sm btn-outline-light" onclick="closeFilePreview()" title="关闭">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        </div>
        <div class="file-preview-info">
            <span class="me-3" id="previewFileSize">
                <i class="bi bi-hdd me-1"></i>大小
            </span>
            <span class="me-3" id="previewFileDate">
                <i class="bi bi-calendar me-1"></i>修改日期
            </span>
            <span class="me-3" id="previewFileEncoding">
                <i class="bi bi-keyboard me-1"></i>编码
            </span>
            <span id="previewFileType">
                <i class="bi bi-file-earmark me-1"></i>类型
            </span>
        </div>
        <div class="file-preview-toolbar">
            <select id="encodingSelect" class="form-select form-select-sm" onchange="changeEncoding(this.value)">
                <option value="auto">自动检测</option>
                <option value="UTF-8">UTF-8</option>
                <option value="GBK">GBK/GB2312</option>
                <option value="GB18030">GB18030</option>
                <option value="Big5">Big5</option>
                <option value="Shift_JIS">Shift_JIS</option>
                <option value="EUC-KR">EUC-KR</option>
                <option value="ISO-8859-1">ISO-8859-1</option>
                <option value="windows-1252">Windows-1252</option>
            </select>
            <div class="btn-group btn-group-sm ms-2">
                <button class="btn btn-outline-light" onclick="wrapText(true)" title="自动换行">
                    <i class="bi bi-text-wrap"></i>
                </button>
                <button class="btn btn-outline-light" onclick="wrapText(false)" title="不换行">
                    <i class="bi bi-unindent"></i>
                </button>
            </div>
            <div class="ms-auto">
                <span class="badge bg-secondary" id="previewLineCount">0 行</span>
            </div>
        </div>
        <div class="file-preview-content" id="previewContent">
            <div class="text-center text-muted p-4">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                <span>加载中...</span>
            </div>
        </div>
        <div class="file-preview-status" id="previewStatus"></div>
    </div>
    
    <!-- 浮窗遮罩层 -->
    <div id="previewOverlay" class="preview-overlay" style="display: none;" onclick="closeFilePreview()"></div>

    <!-- 快捷键帮助模态框 -->
    <div class="modal fade" id="shortcutsModal" tabindex="-1" aria-labelledby="shortcutsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="shortcutsModalLabel">
                        <i class="bi bi-keyboard me-2"></i>键盘快捷键
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="d-flex align-items-center">
                                <kbd class="me-2">/</kbd>
                                <span>聚焦搜索</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex align-items-center">
                                <kbd class="me-2">V</kbd>
                                <span>切换视图</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex align-items-center">
                                <kbd class="me-2">T</kbd>
                                <span>切换主题</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex align-items-center">
                                <kbd class="me-2">R</kbd>
                                <span>刷新页面</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex align-items-center">
                                <kbd class="me-2">ESC</kbd>
                                <span>清除搜索</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex align-items-center">
                                <kbd class="me-2">?</kbd>
                                <span>显示帮助</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 二维码分享模态框 -->
    <div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="qrModalLabel">
                        <i class="bi bi-qr-code me-2"></i>二维码分享
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <% if (serverIPs && serverIPs.length > 0) { %>
                    <!-- 多网卡时选择 IP -->
                    <% if (serverIPs.length > 1) { %>
                    <div class="mb-3">
                        <label class="form-label small text-muted">选择网络地址</label>
                        <select class="form-select form-select-sm mx-auto" id="qrIpSelect" style="max-width: 250px;">
                            <% serverIPs.forEach(function(ip) { %>
                            <option value="<%= ip %>"><%= ip %></option>
                            <% }); %>
                        </select>
                    </div>
                    <% } else { %>
                    <input type="hidden" id="qrIpSelect" value="<%= serverIPs[0] %>">
                    <% } %>
                    <% } else { %>
                    <div class="alert alert-warning small">无法获取服务器 IP 地址</div>
                    <% } %>
                    <div class="mb-3">
                        <label class="form-label small text-muted">下载选项</label>
                        <select class="form-select form-select-sm mx-auto" id="qrDownloadMode" style="max-width: 250px;">
                            <option value="open" selected>直接打开文件/目录</option>
                            <option value="download">下载文件/文件夹</option>
                        </select>
                    </div>
                    <div id="qrCodeContainer" class="d-inline-block p-2"></div>
                    <div class="mt-3 text-muted small" id="qrUrlText"></div>
                    <div class="mt-2 text-muted small">根据下载选项在本地网络中访问或下载当前文件或目录</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 文件上传模态框 -->
    <% if (authEnabled) { %>
    <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadModalLabel">
                        <i class="bi bi-cloud-upload me-2"></i>上传文件到 <%= pathname %>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 拖拽区域 -->
                    <div class="upload-dropzone" id="uploadDropzone">
                        <div class="upload-dropzone-content">
                            <i class="bi bi-cloud-arrow-up display-4 text-muted mb-3"></i>
                            <p class="mb-2">拖拽文件到这里上传</p>
                            <p class="text-muted small mb-3">或点击下方按钮选择文件</p>
                            <label class="btn btn-primary">
                                <i class="bi bi-folder2-open me-1"></i>选择文件
                                <input type="file" id="fileInput" multiple hidden>
                            </label>
                        </div>
                    </div>
                    <!-- 文件列表 -->
                    <div id="uploadFileList" class="upload-file-list mt-3" style="display: none;">
                        <h6 class="mb-2">待上传文件 (<span id="uploadFileCount">0</span>)</h6>
                        <div id="uploadFiles" class="upload-files"></div>
                    </div>
                    <!-- 上传进度 -->
                    <div id="uploadProgress" class="mt-3" style="display: none;">
                        <div class="d-flex justify-content-between mb-1">
                            <span>上传进度</span>
                            <span id="uploadProgressText">0%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="uploadProgressBar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-success" id="startUploadBtn" disabled>
                        <i class="bi bi-upload me-1"></i>开始上传
                    </button>
                </div>
            </div>
        </div>
    </div>
    <% } %>

    <!-- 当前页面隐藏数据 -->
    <input type="hidden" id="serverPort" value="<%= currentPort %>">
    <input type="hidden" id="currentPath" value="<%= pathname %>">
    <input type="hidden" id="authEnabled" value="<%= authEnabled %>">

    <!-- 右键菜单 -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" data-action="preview">
            <i class="bi bi-eye me-2"></i>预览
        </div>
        <div class="context-menu-item" data-action="download">
            <i class="bi bi-download me-2"></i>下载
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" data-action="copy-link">
            <i class="bi bi-link-45deg me-2"></i>复制链接
        </div>
        <div class="context-menu-item" data-action="open-new-tab">
            <i class="bi bi-box-arrow-up-right me-2"></i>在新标签页中打开
        </div>
    </div>

    <!-- 快捷键提示 Toast -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="shortcutsToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="bi bi-keyboard text-primary me-2"></i>
                <strong class="me-auto">快捷键提示</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                按 <kbd>?</kbd> 查看所有快捷键
            </div>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Viewer.js JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/viewerjs@1.11.6/dist/viewer.min.js"></script>
    <!-- XGPlayer JavaScript -->
    <script src="https://unpkg.com/xgplayer@3.0.20/dist/index.min.js"></script>
    <!-- QRCode JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>


    <!-- JavaScript Modules -->
    <script src="/static/js/explorer.js"></script>
    <script src="/static/js/preview.js"></script>
    <script src="/static/js/upload.js"></script>
    <script src="/static/app.js"></script>
</body>
</html>
